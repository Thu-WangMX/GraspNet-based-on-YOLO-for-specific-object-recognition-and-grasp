#!/usr/bin/env python3
import sys
import time
import logging
import math
import numpy as np
import cv2
import pyrealsense2 as rs
import urx

# —— Charuco 板参数 —— #
CHARUCO_DICT = cv2.aruco.getPredefinedDictionary(cv2.aruco.DICT_5X5_1000)

# 手动创建 CharucoBoard
CHARUCO_BOARD = cv2.aruco.CharucoBoard(
    size=(7, 9),           # board size (4x4) 一定要奇数
    dictionary=CHARUCO_DICT,
    squareLength=0.026,     # 格子的物理边长（米）
    markerLength=0.0195      # ArUco 子标记边长（米）

    # squareLength=0.4,     # 格子的物理边长（米）
    # markerLength=0.3      # ArUco 子标记边长（米）
)

# 替代 DetectorParameters_create 的写法
DETECT_PARAMS = cv2.aruco.DetectorParameters()  # 使用 cv2.aruco.DetectorParameters() 代替

def get_aligned_images(pipeline, align):
    """从 RealSense 获取对齐后的 RGB、深度图和相机内参"""
    frames = pipeline.wait_for_frames()
    # aligned = align.process(frames)
    depth_frame = frames.get_depth_frame()
    color_frame = frames.get_color_frame()
    if not depth_frame or not color_frame:
        return None, None, None, None

    # 相机内参
    intr = color_frame.profile.as_video_stream_profile().intrinsics
    intr_matrix = np.array([
        [intr.fx, 0,       intr.ppx],
        [0,       intr.fy, intr.ppy],
        [0,       0,       1]
    ])
    dist_coeffs = np.array(intr.coeffs)

    depth_image = np.asanyarray(depth_frame.get_data())
    color_image = np.asanyarray(color_frame.get_data())
    return color_image, depth_image, intr_matrix, dist_coeffs

def get_jaka_gripper(robot):
    pose = robot.get_pose() 
    print(pose.pos)
    print(pose.orient)
    pos_trans = np.array([pose.pos.x, pose.pos.y, pose.pos.z])
    pos_R = pose.orient
    return  [pos_trans, pos_R]

def get_charuco_pose(rgb, camera_matrix, dist_coeffs):
    """
    检测 ChArUco 板并估计位姿。
    返回：tvec (3,) 和 rvec (3,) 合并的 list，或者 None
    """
 
    gray = cv2.cvtColor(rgb, cv2.COLOR_BGR2GRAY)
 
    # 1. ArUco 检测
    corners, ids, _ = cv2.aruco.detectMarkers(
        gray, CHARUCO_DICT, parameters=DETECT_PARAMS
    )

    if ids is None or len(ids) == 0:
        assert False, "No corners detected."
    
    if len(corners) < 0:
        print("No corners detected.")
        return None

    # 绘制检测到的标记
    output_img = gray.copy()
    output_img = cv2.aruco.drawDetectedMarkers(output_img, corners, ids)


    # cv2.imshow("Detected ArUco Markers", output_img)
    # cv2.waitKey(0)

    # 2. 插值出 ChArUco 角点
    # print("camera_matrix: ", camera_matrix)
    retval, charuco_corners, charuco_ids = cv2.aruco.interpolateCornersCharuco(
        markerCorners=corners,
        markerIds=ids,
        image=gray,
        board=CHARUCO_BOARD,
        cameraMatrix=camera_matrix,
        distCoeffs=dist_coeffs
    )
    # print("camera_matrix: ", camera_matrix)
    # print("retval:", retval)
    # print("charuco_corners:", charuco_corners)

    # cv2.imshow("rgb", rgb)
    # cv2.waitKey(0)

    if retval < 16:
        raise ValueError(f"Not enough corners detected (found {retval}, need at least 4)")
    
    # 3. 估计 CharucoBoard 位姿
    success, rvec, tvec = cv2.aruco.estimatePoseCharucoBoard(
        rvec=np.empty(1),   # dummy rvec 占位
        tvec=np.empty(1),    # dummy tvec 占位
        charucoCorners=charuco_corners,
        charucoIds=charuco_ids,
        board=CHARUCO_BOARD,
        cameraMatrix=camera_matrix,
        distCoeffs=dist_coeffs

    )
    # print("success:", success)
    if not success:
        return None

    # 可视化（可选）
    cv2.aruco.drawDetectedCornersCharuco(rgb, charuco_corners, charuco_ids)
    cv2.drawFrameAxes(rgb, camera_matrix, dist_coeffs, rvec, tvec, 0.1)
    
    # 显示图像
    cv2.imshow("Charuco Detection", rgb)
    # cv2.waitKey(1)  # 这里需要确保调用了waitKey来刷新窗口

    return list(tvec.flatten()) + list(rvec.flatten())


def solve_hand_eye(robot_R_list, robot_t_list, cam_R_list, cam_t_list):
    """
    使用 OpenCV 手眼标定函数求解 X (camera->base):
      R_cam2base, t_cam2base
    """
    methods = {
        'TSAI': cv2.CALIB_HAND_EYE_TSAI,
        # 'PARK': cv2.CALIB_HAND_EYE_PARK,
        'HORAUD': cv2.CALIB_HAND_EYE_HORAUD,
        'ANDREFF': cv2.CALIB_HAND_EYE_ANDREFF,
        'DANIILIDIS': cv2.CALIB_HAND_EYE_DANIILIDIS
    }
    results = {}
    for method_name, method in methods.items():
        R_cam2base, t_cam2base = cv2.calibrateHandEye(
            robot_R_list, robot_t_list,
            cam_R_list, cam_t_list,
            method=method
        )
        results[method_name] = (R_cam2base, t_cam2base)
    return results

    # R_cam2base, t_cam2base = cv2.calibrateHandEye(
    #     robot_R_list, robot_t_list,
    #     cam_R_list,   cam_t_list,
    #     method=cv2.CALIB_HAND_EYE_TSAI
    # )
    # return R_cam2base, t_cam2base

def main():
    logging.basicConfig(level=logging.INFO)
    # —— 初始化 RealSense —— #
    pipeline = rs.pipeline()
    cfg = rs.config()
    cfg.enable_stream(rs.stream.depth, 1280, 720, rs.format.z16, 30)
    cfg.enable_stream(rs.stream.color, 1280, 720, rs.format.bgr8, 30)
    cfg.enable_device("250122073881")
    profile = pipeline.start(cfg)
    align   = rs.align(rs.stream.color)

    # 获取并缓存 color intrinsics
    color_profile = profile.get_stream(rs.stream.color).as_video_stream_profile()
    color_intr   = color_profile.get_intrinsics()
    camera_matrix = np.array([
        [color_intr.fx, 0,             color_intr.ppx],
        [0,             color_intr.fy, color_intr.ppy],
        [0,             0,             1]
    ])
    dist_coeffs = np.array(color_intr.coeffs)

    # —— 初始化机械臂 URX —— #
    robot = urx.Robot("192.168.101.101")
    # robot.set_tcp((0,0,0.,0,0,0))
    robot.set_payload(0.5, (0,0,0))
    time.sleep(0.5)
    logging.info("Robot initialized at: %s", robot.getl())

    gripper_poses = []
    charuco_poses = []



    points = np.array([
# [0.5523781590402801, -0.05631953118981902, 0.4296983885450773, 2.434429226301337, -0.45326581556168377, 1.613690614775641],
# [0.5523824932578515, -0.05636760893074731, 0.429641558179191, 2.474182715064682, -0.3767361637970949, 1.6390274337073167],
# [0.5523597244006235, -0.05630119934048671, 0.42967916295979464, 2.5338785452995083, -0.25102593078705665, 1.677447934737492],
# [0.5523702131274968, -0.05633120691497078, 0.4296193091199871, 2.5745143650644975, -0.1567941663994924, 1.703180524794619],
# [0.5523485250578618, -0.056311633066813804, 0.429671019446451, 2.6188671896682565, -0.04303381694642005, 1.7315426100123679],
# [0.5523915859588221, -0.05631549678171099, 0.42963946938170916, -2.5647868205121536, -0.11466960693647708, -1.6941890077904131],
# [0.5523686441391344, -0.05629509899949757, 0.42963595025621504, -2.506568186067624, -0.25407277990665744, -1.6541210353214075],
# [0.5523874145541035, -0.0563178207780614, 0.42962381735732674, -2.4590785321920787, -0.35597149790489635, -1.6217869177668736],
# [0.5523857588691831, -0.05629635274563563, 0.42961623371393554, -2.4326691587334768, -0.4088180942741741, -1.6038753262319818],
# [0.5523526513352487, -0.05636926662138479, 0.443260703019926, -2.4463281066304003, -0.33000603727817707, -1.6872611358695555],
# [0.5523594844443946, -0.056368808871874565, 0.4432617613905577, -2.487062607812085, -0.24385766506054748, -1.715479866997893],
# [0.5523905608074842, -0.056363860655332776, 0.4432671024636951, -2.5050437557040413, -0.2036771401417394, -1.727936285892499],
# [0.5523673276913846, -0.05637967582132595, 0.443235364513989, -2.535673437128854, -0.1318061361191346, -1.7488166872645765],
# [0.5523462367349933, -0.05634851147257342, 0.4432573990248032, -2.584083985563168, -0.0068979059468323506, -1.782114630652334],
# [0.5523997229524191, -0.05635498515874587, 0.4432301641218333, 2.547000919606412, -0.1021386051848473, 1.756424807607971],
# [0.5523707613311595, -0.056344514748246324, 0.44326737132619953, 2.5128292318028707, -0.18431504105106275, 1.7330941157884088],
# [0.5523732267084547, -0.05637517328034116, 0.44324987489593437, 2.47162063982086, -0.27596706058823883, 1.7045989269952089],
# [0.5523719103189404, -0.05635945042670226, 0.44322819482219733, 2.4311277337102544, -0.35921612307788237, 1.6766526699989477],
# [0.55240738911197, -0.056340831931003366, 0.46150585279114065, 2.3560234815470404, -0.2643801243594716, 1.651839444158577],
# [0.5523665644388956, -0.0563037034666828, 0.4615334739774471, 2.393125007435169, -0.17877553963014595, 1.6848230389318044],
# [0.5523537511472312, -0.05630597874083308, 0.46149800257783113, 2.4426746784653846, -0.05238972683652877, 1.7294346045374942],
# [0.5523590389165794, -0.05632355830702625, 0.46151566282660544, 2.4946012928427574, 0.10109810360686965, 1.777990341758489],
# [0.5523947631280504, -0.04272934244690371, 0.46149364469584253, 2.4423802931597716, 0.1652214496205394, 1.7400842830229197],
# [0.5523814054706473, -0.04271525838594008, 0.46149631702461674, 2.4604482298328096, 0.23478470846978886, 1.7618570165582506],
# [0.5523744129742847, -0.042726884226853265, 0.4615300978229788, 2.4838959448917075, 0.33641555164654574, 1.792029921732341],
# [0.552360423813889, -0.04270558640352279, 0.4615911885557397, 2.4959783131226017, 0.3960901096841519, 1.8087190297444022],
# [0.5524001183029762, -0.04272220447100196, 0.4614680774142088, -2.498969063109713, -0.49236020201303954, -1.823036622136212],
# [0.5523812614660295, -0.04278250006918911, 0.46149562352324364, -2.4035643675597305, -0.24439230278235213, -1.7999078756731035],
# [0.5523789025725253, -0.04278277349780892, 0.4615460176948887, -2.4133890802409326, -0.22351696453823566, -1.8075457011828713],
# [0.5523781838422039, -0.04278377949141122, 0.46147860017390674, -2.4420575598577616, -0.03965979851852196, -1.842380609487414],
# [0.5523984081347444, -0.042767127962033795, 0.4614617552476697, -2.3516401276691554, 0.08135420991764293, -1.7829183988002222],
# [0.5523824851884918, -0.042722723441913545, 0.4615195571758296, -2.370259804407753, 0.14345094399401662, -1.8060638390573114],
# [0.5523812731654212, -0.04276884718020938, 0.4615152583174686, -2.40046160535911, 0.2546198352118316, -1.844866516428564],
# [0.5856070578925547, -0.04268988785087233, 0.4614670023785271, -2.4003403332770277, 0.25447874267177095, -1.8448435374056222],
# [0.5855680317675289, -0.042777630494604875, 0.46153653256951166, -2.431761592281458, 0.39146750636697303, -1.8886086788139795],
# [0.5855553617461686, -0.04275286885875547, 0.4615188209417589, 2.4330960428682022, -0.4950349431017459, 1.9045509241442697],
# [0.5855570565272948, -0.042745769504384225, 0.46151950609302206, -2.3433251873340417, 0.4967864862205888, -2.0276585199491404],
# [0.585563518754057, -0.042753566026103106, 0.4615718383808203, -2.279606358839033, 0.593071775625928, -1.9460657883564947],
# [0.5855618991104159, -0.04274984258477707, 0.4615031639677889, 2.2464757280978316, -0.30473524925047024, 1.9854068525355337],
# [0.5856011824825484, -0.04273383853800853, 0.4614806380397753, 2.1806965559672675, -0.19262728905007787, 1.9521964521123458],
# [0.585608265684991, -0.04271862338168741, 0.4614380138325948, 2.285408857109301, -0.17401091174728095, 1.8188047162363041],
# [0.5856000635567883, -0.04274248326017693, 0.4615013434633678, 2.3602737604534743, -0.15972606837064726, 1.7133784090250765],
# [0.5855580188455505, -0.04273336467427949, 0.46155265135173335, 2.4156932234236823, -0.015631272302845764, 1.766804257365732],
# [0.5855841496339312, -0.04268821146348374, 0.46155597126696957, 2.4598647483404106, 0.11703198804917983, 1.8108479261183943],
# [0.5856099763991159, -0.0427188576590212, 0.4614964919732624, 2.493757463457394, 0.233673599083934, 1.845513101994505],
# [0.5855855843535751, -0.04276019036627139, 0.4615277567155438, 2.379510836515437, 0.2299560521379722, 1.9777598758810226],
# [0.5855782708319055, -0.04270435010355156, 0.4614808008587539, 2.3977039580090733, 0.2949545592488216, 1.9994202654268638],
# [0.5855707773242651, -0.04277287371315895, 0.4615305125253238, 2.3268475061424625, 0.06534281304928052, 1.9172394700439759],
# [0.5855676595880719, -0.042734853939231696, 0.46154542543402455, 2.264330927330416, 0.059408552395000314, 1.9889658609614151],
# [0.5951882514445728, -0.042783889613983654, 0.4971149775586493, 2.264335367454653, 0.05927404262754843, 1.9888975326619422],
# [0.5951547116864436, -0.0427591484168958, 0.49714279433875735, 2.2422895712689277, 0.0005200663205890041, 1.963334539654219],
# [0.5951605749068116, -0.04269819610887674, 0.49717333020161525, 2.2985755829132155, 0.1579992719021829, 2.029649167399774],
# [0.5951728481401063, -0.0427179511540916, 0.4971535574542044, 2.3200150635306356, 0.22557917603918776, 2.0557070348563355],
# [0.5951758926387442, -0.04277769605423154, 0.4971579014274205, 2.2477462850710785, 0.34251523815447876, 1.9807679121151975],
# [0.5952196888619523, -0.04270591716746594, 0.4970337796219675, 2.3587269641925923, 0.3536540223655713, 1.865367321872879],
# [0.5952033128116889, -0.04270098516728766, 0.49709090712072557, 2.539627127948557, 0.3706816642426455, 1.6483152293356125],
[0.6706573881484379, -0.05278173543153092, 0.24578593676601962, -2.6103721438618894, 0.08732322728172136, -1.5292290315429606],
[0.670630853258962, -0.07518166992476243, 0.24570777540542538, -2.610466818118531, 0.087281221964958, -1.5289323241965866],
[0.6706159436676442, -0.11560070102858001, 0.24573909133538574, -2.6104341819764594, 0.08731187479937863, -1.5289918399352516],
[0.670651665038627, -0.1155960491103914, 0.24573925265758303, -2.6383515475054016, 0.19922322698385772, -1.5550264957658586],
[0.6706620790363369, -0.11555849540830467, 0.24572686920814696, -2.661820988891875, 0.30922577517902805, -1.5780727657240725],
[0.6706449179207595, -0.11556515654966236, 0.24565166324313664, 2.674190398538101, -0.40314554622304755, 1.5932331868371437],
[0.6706636138956312, -0.11555712020898735, 0.24569466960428044, 2.6237998111254686, -0.4999686232560169, 1.57235755932153],
[0.6706643464745036, -0.11554901985711274, 0.24572841319067573, 2.5576080758021984, -0.6168685062607416, 1.5439594593243502],
[0.6706338489110536, -0.11559486905307143, 0.24577159003815957, 2.4959617130734704, -0.6266291661161527, 1.6736134594499752],
[0.6706516190712319, -0.1156030277186072, 0.24573899247843667, 2.4517179315474262, -0.6323063991526144, 1.7584387795382463],
[0.6706353354730317, -0.11559207637556451, 0.24566807289382941, 2.5090032592258957, -0.5443201642052838, 1.7850585661189853],
[0.6950711083832015, -0.11553404764962169, 0.24569502416917158, 2.5090583499968844, -0.5442258318243597, 1.7851273997438433],
[0.6950536772351728, -0.1156155150218421, 0.24569481643870072, -2.507510500354477, 0.3957417380928081, -1.7635910602005493],
[0.695013407645259, -0.11564671330475053, 0.24570972915238948, -2.476686995545284, 0.24901515368393842, -1.7221474572439965],
[0.6950360958091841, -0.11559125941763539, 0.24571779664446264, -2.4353348818674934, 0.09122306690027185, -1.6721400519679197],
[0.6950369249641108, -0.11557465974871312, 0.2457609781147728, -2.3885778641006823, -0.05662513796781599, -1.6199551076803236],
[0.6950367623097514, -0.11558786574686997, 0.24576201143504806, -2.3503169230459076, -0.16207656407508977, -1.5792007643481538],
[0.6950519871590276, -0.11558056613698955, 0.245792390510025, -2.305801074227381, -0.27143522262592906, -1.533759578359679],
[0.695040768737683, -0.11554531315063293, 0.2457937868974896, -2.229769102224636, -0.4352035304795675, -1.4591978546836806],
[0.6950674000531303, -0.11553244480480421, 0.24570601146360718, -2.314420861812603, -0.3892318740694703, -1.2906085250143937],
[0.6950592270924045, -0.11561106987911196, 0.24566242224453055, -2.4383451005043626, -0.5023070219346297, -1.301680842299288],
[0.6950756340460755, -0.11560241671330047, 0.2457276860675874, -2.5302720918797994, -0.5920420746097242, -1.3066693914659078],
[0.6950544667675242, -0.11563601570100573, 0.24563844711212565, -2.6006393845536078, -0.664008064880092, -1.3079878298885743],
[0.6950685583396448, -0.1156273753696219, 0.24572320354175842, -2.718487944183202, -0.4278247328792633, -1.3577833107062864],
[0.695089773681953, -0.11558502719267906, 0.24574335628971156, -2.786101104982875, -0.26542434173067236, -1.3852880631410127],
[0.6950597101533739, -0.11558133495377591, 0.2457244514726521, 2.7656335488461923, 0.027240685689601123, 1.3664139808843956],
[0.6950906252258355, -0.08553427421989998, 0.2457085164533972, 2.765673662322345, 0.027319116227747152, 1.3664249165879883],
[0.6950425793638566, -0.0855865757927099, 0.226938717677397, 2.76567794257528, 0.027174816367726257, 1.3664492417770593],
[0.6950434135217335, -0.08558261593582052, 0.22689701790302624, 2.7283623850043965, -0.10290461190786096, 1.3431929236856046],
[0.6714465401493375, -0.0855600502283447, 0.2269574220779051, 2.778760557004537, 0.078405358334587, 1.3748688663006676],
[0.6714245557019826, -0.08562697030878509, 0.22695869009317474, -2.7811050202123337, -0.27829313616240037, -1.3832202718123412],
[0.6714711617510163, -0.08557645676494828, 0.2269427230307402, -2.4431847087619403, 0.008291887372505182, -1.2693925615538524],
[0.6714680317469401, -0.08555518720857098, 0.22694588294628326, -2.367863299076888, 0.06309271872844573, -1.2422080715056127],
[0.6866667937219766, -0.08563310800577523, 0.2269384576037044, -2.36787532517072, 0.06331526065314977, -1.2422558258658534],
[0.6866431301774361, -0.08562524188102723, 0.21377137570920396, -2.3678654462363236, 0.06320452437339746, -1.2423142621022165],
[0.6866784887546387, -0.08557116021352171, 0.21370899236480578, -2.391162013107931, 0.18737394543979638, -1.289267045147548],
[0.6866540331187183, -0.08557222315678488, 0.21369301535981466, -2.4077176986629953, 0.30044968222495777, -1.3296839645519307],
[0.6866679900719088, -0.08559990015381128, 0.2628892070468054, -2.407683764266651, 0.30054439485152573, -1.3297018278512507],
[0.7134536393989036, -0.08563373292939827, 0.26293607186466694, -2.407669978763908, 0.30059192084926023, -1.3298428074374473],
[0.713456981358417, -0.08560811752323995, 0.2629153112493698, -2.5330195193664733, 0.20460125779971763, -1.3998932138400157],
[0.7134522471111777, -0.0855965903659864, 0.2629659191742767, -2.2762418365882007, 0.147733241180065, -1.762402338846527],
[0.7134689827627303, -0.08556098942127428, 0.26301036479098183, -2.307725395605092, 0.27335503471738376, -1.8134735939294373],
[0.7134612201810381, -0.08563602558585644, 0.2628979029926401, -2.33818209278922, 0.23475824801343254, -1.838012833873634],
[0.713475173414851, -0.08554642950735086, 0.2629071617744284, -2.5489222961296747, 0.261652447244386, -1.5652184930953654],
[0.7134676348828234, -0.08553756170460144, 0.2629721006736762, -2.5724725724136364, 0.39255832250345296, -1.598157672869896],
[0.7134356603958656, -0.08555533934036481, 0.2628786920877687, -2.5914321813932424, 0.5289157914915447, -1.628901957520923],
[0.71346807342062, -0.05073346043679698, 0.26292256459010105, -2.5912375147688493, 0.529045889688379, -1.6289995048664585],
[0.7388350638063172, -0.05080060265009325, 0.26294405011080735, -2.5912479542939573, 0.5291362763714373, -1.6291544958744302],
[0.7387783773881588, -0.05082829003213664, 0.26295571353633074, 2.5350368369034895, -0.3862896894791722, 1.6334179355748497],
[0.7387863696879677, -0.050857183252360584, 0.26294761883651807, 2.4646956113195135, -0.2996082446532609, 1.61099582808168],
[0.7387960177988717, -0.05081970505911895, 0.2629408435694734, 2.390622253308326, -0.21360183582197612, 1.5856495446975534],
[0.7387910054423147, -0.0508363620518677, 0.2629416087946581, 2.3174869194126786, -0.1336783305176726, 1.5592228005252613],
[0.7387914787507686, -0.05080040525875043, 0.2629301179364644, 2.386053674004562, 0.07714723397602667, 1.6420893870228286],
[0.7387961018896956, -0.050838999003673224, 0.26289925752449106, 2.423217402260666, 0.21920353895667682, 1.6916935617382538],
[0.7387828376546166, -0.05077555481893574, 0.26288089662616426, 2.448965955542792, 0.337723504813014, 1.7293787501433968]
    ])

    for point in points:
        # robot.movel("movel", pose=pose, relative=True)
        robot.movel(point, acc=0.2, vel=0.2, wait=True)
        time.sleep(1)
        rgb, depth, K, dist = get_aligned_images(pipeline, align)
        if rgb is None:
            continue

        pose = get_charuco_pose(rgb, camera_matrix, dist_coeffs)
        key = cv2.waitKey(33) & 0xFF


        gp = get_jaka_gripper(robot)
        if pose is not None:
            gripper_poses.append(gp)
            charuco_poses.append(pose)
            logging.info("Recorded sample %d", len(gripper_poses))
        else:
            logging.warning("Charuco board not detected this frame.")


    # 收集 R, t

    R_gripper_in_base, R_target_in_camera = [], []
    t_gripper_in_base, t_target_in_camera = [], []


    for marker in charuco_poses:
        #m-c的旋转矩阵和位移矩阵
        camera_rot = marker[3:6] # 3:6 是旋转向量
        camera_mat,_ = cv2.Rodrigues((camera_rot[0],camera_rot[1],camera_rot[2])) #旋转矢量到旋转矩阵
        R_target_in_camera.append(camera_mat)
        t_target_in_camera.append(np.array(marker[0:3])) 


    for gripper in gripper_poses:

        # g-b的旋转矩阵和位移矩阵
        gripper_rot = gripper[1].get_array()
        gripper_pos = gripper[0]
        R_gripper_in_base.append(gripper_rot) #欧拉角到旋转矩阵；# 表示为按照xyz
        t_gripper_in_base.append(gripper_pos) 


    data = {
        'R_target_in_camera': R_target_in_camera,
        't_target_in_camera': t_target_in_camera,
        'R_gripper_in_base':   R_gripper_in_base,
        't_gripper_in_base':   t_gripper_in_base
    }

    # 保存到 .npy 文件
    np.save('calibration_data_without_tcp.npy', data)


    R_gripper_in_base = np.array(R_gripper_in_base)
    t_gripper_in_base = np.array(t_gripper_in_base)
    R_target_in_camera = np.array(R_target_in_camera)
    t_target_in_camera = np.array(t_target_in_camera)

    # T_end_effector_in_base
    T_ee_b = np.zeros((len(R_gripper_in_base), 4, 4))
    for i in range(len(T_ee_b)):
        T_ee_b[i][:3, :3] = R_gripper_in_base[i]
        T_ee_b[i][:3, 3] = t_gripper_in_base[i]


    T_b_ee = np.zeros_like(T_ee_b)
    for i in range(len(T_ee_b)):
        T_b_ee[i][:3, :3] = np.transpose(T_ee_b[i][:3, :3])
        T_b_ee[i][:3, 3] = -np.dot(np.transpose(T_ee_b[i][:3, :3]), T_ee_b[i][:3, 3])

    r_b_ee = T_b_ee[:, :3, :3].reshape(-1, 3, 3)
    t_b_ee = T_b_ee[:, :3, 3].reshape(-1, 3)
    r_t_c = R_target_in_camera.reshape(-1, 3, 3)
    t_t_c = t_target_in_camera.reshape(-1, 3)

    print(len(r_b_ee),len(t_b_ee))
    results = solve_hand_eye(r_b_ee, t_b_ee, r_t_c, t_t_c)

    for k, v in results.items():
        R_c_b, t_c_b = v

        T_c_b = np.eye(4)
        T_c_b[:3, :3] = R_c_b
        T_c_b[:3, 3] = t_c_b.flatten()

        print(f"{k}:")
        for row in T_c_b:
            print(f"[ {row[0]:.8f}, {row[1]:.8f}, {row[2]:.8f}, {row[3]:.8f} ],")

    cv2.destroyAllWindows()
    pipeline.stop()
    robot.close()

if __name__ == "__main__":
    main()
